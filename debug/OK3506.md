dts路径：
```sh
RK_KERNEL_DTS=kernel/arch/arm/boot/dts/OK3506-S_linux_emmc.dts
/home/forlinx/work/OK3506_Linux_Source/kernel/arch/arm/boot/dts/OK3506-S_linux_emmc.dts

```
deconfig路径：
```sh
RK_DEFCONFIG=OK3506-S_linux_emmc_defconfig
forlinx@ubuntu:~/work/OK3506_Linux_Source$ find . -name OK3506-S_linux_emmc_defconfig
./device/rockchip/.chips/ok3506/OK3506-S_linux_emmc_defconfig
/home/forlinx/work/OK3506_Linux_Source/device/rockchip/.chips/ok3506/OK3506-S_linux_emmc_defconfig
/home/forlinx/work/OK3506_Linux_Source/kernel-6.1/arch/arm/configs/OK3506-S_linux_defconfig
```

使用menuconfig更改内核配置并保存：
```
make ARCH=arm OK3506-S_linux_defconfig
make ARCH=arm menuconfig 
make ARCH=arm savedefconfig  
cp defconfig arch/arm/configs/OK3506-S_linux_defconfig  
```
开启gt9xx触摸驱动支持：
```
  
-> Device Drivers
	-> Input device support 
		-> Generic input layer (needed for keyboard, mouse, ...) (INPUT [=y])
			-> Touchscreens (INPUT_TOUCHSCREEN [=y])
```
修改设备树：
```dts  title=OK3506-s-common.dtsi
	gt9xx_rgb: gt9xx-rgb@14 {
		compatible = "goodix,gt9xx";
		reg = <0x14>;
		pinctrl-names = "defaults";
		pinctrl-0 = <&ft5x06_mipi_gpio>;
		reset-gpio = <&gpio4 RK_PB3 GPIO_ACTIVE_HIGH>;
		interrupt-parent = <&gpio4>;
		interrupts = <RK_PB2 IRQ_TYPE_EDGE_FALLING>;
		irq-gpio = <&gpio4 RK_PB2 GPIO_ACTIVE_HIGH>;
		touchscreen-size-x = <1280>;
		touchscreen-size-y = <800>;
		touchscreen-inverted-x;
		touchscreen-inverted-y;
		uniq = "rgb";
		status = "okay";
	};

```
触摸没效果，继续debug
dmesg和i2cdetect：
```
root@ok3506-buildroot:/# dmesg | grep failed
[    5.536593] dw-mipi-dsi-rockchip ff640000.dsi: failed to find panel or bridge: -517
[    7.009199] rtc-pcf8563: probe of 2-0051 failed with error -5
[    7.025172] [BT_RFKILL]: bluetooth_platdata_parse_dt: clk_get failed!!!.
[    7.087066] platform regulatory.0: Direct firmware load for regulatory.db failed with error -2
[    7.087099] cfg80211: failed to load regulatory.db
[    7.317804] edt_ft5x06 0-0038: touchscreen probe failed
root@ok3506-buildroot:/# i2cdetect -y 0
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- 14 -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --
root@ok3506-buildroot:/#
```
检测到了i2c设备地址是0x14，这就是gt9271的地址，但是加载驱动加载的`edt_ft5x06 0-0038: touchscreen probe failed`不正确，menuconfig禁用这个触摸驱动。

```
root@ok3506-buildroot:/# dmesg | grep -i "goodix\|gt9xx\|touch"
[    6.941605] Error: Driver 'Goodix-TS' is already registered, aborting...
[    6.943509] Goodix-TS 0-0014: supply AVDD28 not found, using dummy regulator
[    6.943792] Goodix-TS 0-0014: supply VDDIO not found, using dummy regulator
[    7.031887] Goodix-TS 0-0014: ID 9271, version: 1050
[    7.032024] Goodix-TS 0-0014: Direct firmware load for goodix_9271_cfg.bin failed with error -2
[    7.036745] input: Goodix Capacitive TouchScreen as /devices/platform/ff040000.i2c/i2c-0/0-0014/input/input0

```
还是有些问题，xy轴相反，以及上述报错，上述报错是因为menuconfig开启了两个兼容gt9271的驱动，关掉多余的即可。
查看输入设备：
```bash
ls /dev/input/
by-path  event0  event1  event2
```
用 `evtest` 测试触摸事件：
```bash
evtest /dev/input/event0
```
有消息，代表有一个触摸驱动生效，但是后来发现不是我需要的：
```sh
Event: time 1210.060844, -------------- SYN_REPORT ------------
Event: time 1210.079645, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 1232
Event: time 1210.079645, type 3 (EV_ABS), code 0 (ABS_X), value 1232
Event: time 1210.079645, -------------- SYN_REPORT ------------
Event: time 1210.115990, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 1231
Event: time 1210.115990, type 3 (EV_ABS), code 0 (ABS_X), value 1231
Event: time 1210.115990, -------------- SYN_REPORT ------------
Event: time 1210.152234, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 1230
Event: time 1210.152234, type 3 (EV_ABS), code 0 (ABS_X), value 1230
Event: time 1210.152234, -------------- SYN_REPORT ------------
Event: time 1210.187783, type 3 (EV_ABS), code 57 (ABS_MT_TRACKING_ID), value -1
Event: time 1210.187783, type 1 (EV_KEY), code 330 (BTN_TOUCH), value 0
Event: time 1210.187783, -------------- SYN_REPORT ------------
```
menuconfig禁用其他驱动之后，
```
Goodix-TS 2-0014: no max-x defined
```
查源码发现
```c title=gt9xx.c
    if (!np) {
    	dev_err(&client->dev, "no device tree\n");
    	return -EINVAL;
    }
    if (of_property_read_u32(np, "tp-size", &val)) {
    	dev_err(&client->dev, "no max-x defined\n");
    	return -EINVAL;
    }
    
    // 以及
	if (of_property_read_u32(np, "max-x", &val)) {
    	dev_err(&client->dev, "no max-x defined\n");
    	return -EINVAL;
    }
    //ts->abs_x_max = val;
    if (of_property_read_u32(np, "max-y", &val)) {
    	dev_err(&client->dev, "no max-y defined\n");
    	return -EINVAL;
    }
```

修改设备树，添加`tp-size`，`max-x`，`max-y`，去掉无用属性：
```dts   title=OK3506-s_linux_emmc.dts
&i2c0 {
	status = "okay";
	gt9xx: gt9xx@14 {
		compatible = "goodix,gt9xx";
		reg = <0x14>;
		pinctrl-names = "defaults";
		pinctrl-0 = <&ft5x06_mipi_gpio>;
		reset-gpio = <&gpio4 RK_PB3 GPIO_ACTIVE_HIGH>;
		interrupt-parent = <&gpio4>;
		interrupts = <RK_PB2 IRQ_TYPE_EDGE_FALLING>;
		touch-gpio = <&gpio4 RK_PB2 GPIO_ACTIVE_HIGH>;
	    tp-size = <9271>;
	    max-x = <1280>;
	    max-y = <800>;
		status = "okay";
	};
};
```
`tp-size = <9271>`在驱动代码中主要控制xy轴对换以及翻转，但是源码中没有这个型号的分支，添加分支
```c title=gt9xx.c
    if (of_property_read_u32(np, "tp-size", &val)) {
    	dev_err(&client->dev, "no max-x defined\n");
    	return -EINVAL;
    }

	if (val == 89) {
		m89or101 = TRUE;
		gtp_change_x2y = TRUE;
		gtp_x_reverse = FALSE;
		gtp_y_reverse = TRUE;
	} else if (val == 101) {
		m89or101 = FALSE;
		gtp_change_x2y = TRUE;
		gtp_x_reverse = TRUE;
		gtp_y_reverse = FALSE;
	} else if (val == 911) {
		m89or101 = FALSE;
		bgt911 = TRUE;
		gtp_change_x2y = TRUE;
		gtp_x_reverse = FALSE;
		gtp_y_reverse = TRUE;
	} else if (val == 9110) {
		m89or101 = FALSE;
		bgt9110 = TRUE;
		gtp_change_x2y = FALSE;
		gtp_x_reverse = FALSE;
		gtp_y_reverse = FALSE;
	} else if (val == 9111) {
		m89or101 = FALSE;
		bgt9111 = TRUE;
		gtp_change_x2y = TRUE;
		gtp_x_reverse = FALSE;
		gtp_y_reverse = FALSE;
	} else if (val == 970) {
		m89or101 = FALSE;
		bgt911 = FALSE;
		bgt970 = TRUE;
		gtp_change_x2y = FALSE;
		gtp_x_reverse = FALSE;
		gtp_y_reverse = TRUE;
	} else if (val == 910) {
		m89or101 = FALSE;
		bgt911 = FALSE;
		bgt970 = FALSE;
		bgt910 = TRUE;
		gtp_change_x2y = TRUE;
		gtp_x_reverse = FALSE;
		gtp_y_reverse = TRUE;
	} else if (val == 9271) {  // 添加9271分支
		m89or101 = FALSE;
		bgt911 = FALSE;
		bgt970 = FALSE;
		bgt910 = TRUE;
		gtp_change_x2y = TRUE;
		gtp_x_reverse = FALSE;
		gtp_y_reverse = TRUE;
	}
```



查看输入设备：
```bash
ls /dev/input/
by-path  event0  event1  event2
```
用 `evtest` 测试触摸事件：
```bash
evtest /dev/input/event0
```
没有触摸数据传入，重新检查设备树源码，以及驱动源码
修改reset-gpio极性为`reset-gpio = <&gpio1 RK_PA1 GPIO_ACTIVE_LOW>;`
```dts title=OK3506-S_linux_emmc.dts
// Touch  
&i2c0 {
	status = "okay";
	gt9xx: gt9xx@14 {
		compatible = "goodix,gt9xx";
		reg = <0x14>;
		pinctrl-names = "defaults";
		pinctrl-0 = <&ft5x06_mipi_gpio>;
		reset-gpio = <&gpio4 RK_PB3 GPIO_ACTIVE_LOW>;
		interrupt-parent = <&gpio4>;
		interrupts = <RK_PB2 IRQ_TYPE_EDGE_FALLING>;
		touch-gpio = <&gpio4 RK_PB2 GPIO_ACTIVE_HIGH>;
    tp-size = <9271>;
    max-x = <1280>;
    max-y = <800>;
		status = "okay";
	};
};
```
无效
修改touch-gpio极性为`touch-gpio = <&gpio4 RK_PB2 GPIO_ACTIVE_LOW>;`

```
// Touch  
&i2c0 {
	status = "okay";
	gt9xx: gt9xx@14 {
		compatible = "goodix,gt9xx";
		reg = <0x14>;
		pinctrl-names = "defaults";
		pinctrl-0 = <&ft5x06_mipi_gpio>;
		reset-gpio = <&gpio4 RK_PB3 GPIO_ACTIVE_HIGH>;
		interrupt-parent = <&gpio4>;
		interrupts = <RK_PB2 IRQ_TYPE_EDGE_FALLING>;
		touch-gpio = <&gpio4 RK_PB2 GPIO_ACTIVE_LOW>;
    tp-size = <9271>;
    max-x = <1280>;
    max-y = <800>;
		status = "okay";
	};
};

```
无效

修改`tp-size = <89>;`
```
&i2c0 {
	status = "okay";
	gt9xx: gt9xx@14 {
		compatible = "goodix,gt9xx";
		reg = <0x14>;
		pinctrl-names = "defaults";
		pinctrl-0 = <&ft5x06_mipi_gpio>;
		reset-gpio = <&gpio4 RK_PB3 GPIO_ACTIVE_LOW>;
		interrupt-parent = <&gpio4>;
		interrupts = <RK_PB2 IRQ_TYPE_LEVEL_LOW>;
		touch-gpio = <&gpio4 RK_PB2 GPIO_ACTIVE_LOW>;
    tp-size = <89>;
    max-x = <1280>;
    max-y = <800>;
		status = "okay";
	};
};


```
仿照正点原子的设备树
```
&i2c2{
    dsi1_touch: gt9xx@14 {
        compatible = "goodix,gt9xx";
        reg = <0x14>;
        pinctrl-names = "default";
        pinctrl-0 = <&touch1_gpio>;
        touch-gpio = <&gpio0 RK_PA6 IRQ_TYPE_LEVEL_LOW>;
        reset-gpio = <&gpio0 RK_PA7 GPIO_ACTIVE_HIGH>;
        max-x = <720>;
        max-y = <1280>;
        tp-size = <911>;
        tp-supply = <&vcc_sys>;
        wakeup-source;
        goodix-ts-name = "dsi1_ts_gt9xx";
        status = "okay";
        /delete-node/ gt1x;
    };
};
```

